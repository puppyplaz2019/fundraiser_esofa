<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESOFA Harmony Drop - Leaderboard Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #0a0a12; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* UI Panels */
        .panel { position: absolute; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 15px; backdrop-filter: blur(10px); }
        
        #stats { top: 20px; left: 20px; width: 120px; text-align: center; }
        #score { font-size: 32px; font-weight: bold; color: #00ffff; }
        
        #leaderboard { top: 20px; right: 20px; width: 180px; max-height: 300px; overflow-y: hidden; }
        .entry { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        #next-preview { bottom: 20px; left: 20px; width: 100px; text-align: center; }
        
        #donate-btn {
            position: absolute; bottom: 20px; right: 20px;
            background: linear-gradient(135deg, #ff00cc, #3333ff);
            color: white; padding: 15px 30px; border-radius: 50px;
            text-decoration: none; font-weight: bold; box-shadow: 0 0 20px rgba(51, 51, 255, 0.5);
            transition: 0.3s; z-index: 100;
        }
        #donate-btn:hover { transform: scale(1.1); box-shadow: 0 0 30px #ff00cc; }

        canvas { border: 4px solid #1a1a2e; border-radius: 10px; }
        
        #game-over-screen {
            position: absolute; display: none; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; border: 2px solid #00ffff;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="stats" class="panel">
        <div>SCORE</div>
        <div id="score">0</div>
        <div style="font-size: 10px; margin-top: 5px;">BEST: <span id="best">0</span></div>
    </div>

    <div id="leaderboard" class="panel">
        <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #00ffff;">LOCAL LEGENDS</div>
        <div id="leader-list">
            </div>
    </div>

    <div id="next-preview" class="panel">
        <div style="font-size: 12px;">NEXT</div>
        <div id="next-label" style="font-weight: bold; color: #ff00cc;">?</div>
    </div>

    <a id="donate-btn" href="https://www.sanangelogives.org/organization/emmanuelschooloffinearts" target="_blank">üíù TIP THE SCHOOL</a>

    <div id="game-over-screen">
        <h2 style="color:#ff00cc">STAGE FULL!</h2>
        <p>New High Score? Enter your name:</p>
        <input type="text" id="player-name" maxlength="10" style="padding: 5px; border-radius: 5px; border: none;">
        <button onclick="saveScore()" style="margin-top: 15px; padding: 10px 20px; background: #00ffff; border: none; border-radius: 5px; cursor: pointer;">SAVE & RESTART</button>
    </div>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
    const engine = Engine.create();
    const width = 400; const height = 650;

    const render = Render.create({
        element: document.getElementById('game-container'),
        engine: engine,
        options: { width, height, wireframes: false, background: 'transparent' }
    });

    const ORBS = [
        { r: 15, color: '#ff6b6b', name: 'Note', pts: 2 },
        { r: 25, color: '#feca57', name: 'Chord', pts: 4 },
        { r: 35, color: '#ff9ff3', name: 'Flute', pts: 8 },
        { r: 45, color: '#54a0ff', name: 'Violin', pts: 16 },
        { r: 60, color: '#5f27cd', name: 'Trumpet', pts: 32 },
        { r: 75, color: '#48dbfb', name: 'Guitar', pts: 64 },
        { r: 90, color: '#1dd1a1', name: 'Drum', pts: 128 },
        { r: 110, color: '#222f3e', name: 'Piano', pts: 256 },
        { r: 130, color: '#ffd700', name: 'HARP', pts: 512 }
    ];

    const ground = Bodies.rectangle(width/2, height+20, width, 60, { isStatic: true, render: { fillStyle: '#1a1a2e' } });
    const wallL = Bodies.rectangle(-20, height/2, 50, height, { isStatic: true });
    const wallR = Bodies.rectangle(width+20, height/2, 50, height, { isStatic: true });
    Composite.add(engine.world, [ground, wallL, wallR]);

    let score = 0;
    let nextIdx = Math.floor(Math.random() * 3);
    let canDrop = true;
    let leaders = JSON.parse(localStorage.getItem('esofa_leaders')) || [];

    function updateLeaderboard() {
        const list = document.getElementById('leader-list');
        list.innerHTML = leaders.sort((a,b) => b.score - a.score).slice(0, 5)
            .map(l => `<div class="entry"><span>${l.name}</span><span>${l.score}</span></div>`).join('');
        document.getElementById('best').innerText = leaders[0]?.score || 0;
    }

    function dropOrb(x) {
        if(!canDrop) return;
        canDrop = false;
        const orb = Bodies.circle(x, 50, ORBS[nextIdx].r, {
            restitution: 0.4,
            label: 'orb_' + nextIdx,
            render: { fillStyle: ORBS[nextIdx].color }
        });
        Composite.add(engine.world, orb);
        nextIdx = Math.floor(Math.random() * 3);
        document.getElementById('next-label').innerText = ORBS[nextIdx].name;
        document.getElementById('next-label').style.color = ORBS[nextIdx].color;
        setTimeout(() => canDrop = true, 800);
    }

    render.canvas.addEventListener('click', (e) => {
        const rect = render.canvas.getBoundingClientRect();
        dropOrb(e.clientX - rect.left);
    });

    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach(pair => {
            if(pair.bodyA.label === pair.bodyB.label && pair.bodyA.label.includes('orb_')) {
                const idx = parseInt(pair.bodyA.label.split('_')[1]);
                if(idx < ORBS.length - 1) {
                    const midX = (pair.bodyA.position.x + pair.bodyB.position.x) / 2;
                    const midY = (pair.bodyA.position.y + pair.bodyB.position.y) / 2;
                    Composite.remove(engine.world, [pair.bodyA, pair.bodyB]);
                    const newOrb = Bodies.circle(midX, midY, ORBS[idx+1].r, {
                        label: 'orb_' + (idx+1),
                        render: { fillStyle: ORBS[idx+1].color }
                    });
                    Composite.add(engine.world, newOrb);
                    score += ORBS[idx+1].pts;
                    document.getElementById('score').innerText = score;
                }
            }
        });
    });

    // Lose Logic
    setInterval(() => {
        engine.world.bodies.forEach(b => {
            if(b.position.y < 80 && !b.isStatic && b.id > 10) { // If balls pile to top
                document.getElementById('game-over-screen').style.display = 'flex';
            }
        });
    }, 2000);

    function saveScore() {
        const name = document.getElementById('player-name').value || "Anonymous";
        leaders.push({name, score});
        localStorage.setItem('esofa_leaders', JSON.stringify(leaders));
        location.reload();
    }

    Render.run(render);
    Runner.run(Runner.create(), engine);
    updateLeaderboard();
    document.getElementById('next-label').innerText = ORBS[nextIdx].name;
</script>
</body>
</html>
