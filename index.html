<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESOFA Harmony Drop: V1.11 Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #050508; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffff; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .panel { position: absolute; background: rgba(0, 255, 255, 0.1); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; z-index: 10; pointer-events: none; }
        #stats { top: 20px; left: 20px; }
        #next-preview { bottom: 20px; left: 20px; border-color: #ff00ff; }
        
        #donation-modal {
            position: absolute; display: none; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.95); padding: 30px; border: 3px solid #ff00ff; border-radius: 15px;
            z-index: 1000; width: 320px; text-align: center;
        }
        .tip-link {
            width: 100%; padding: 12px; margin: 5px 0; background: #ff0000; 
            color: #fff; text-decoration: none; text-align: center; 
            font-weight: bold; border-radius: 5px; display: block;
        }
        .btn { position: absolute; cursor: pointer; background: #ff00ff; color: #fff; padding: 12px 20px; border: none; font-weight: bold; border-radius: 5px; z-index: 100; }
        #tip-menu-btn { bottom: 20px; right: 20px; }
        canvas { border: 3px solid #00ffff; background: #0a0a15; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="stats" class="panel">SCORE: <span id="score">0</span></div>
    <div id="next-preview" class="panel">NEXT: <span id="next-icon" style="font-size:30px;">ðŸªˆ</span></div>

    <div id="donation-modal">
        <h2 style="color:#ff00ff;">COMMUNITY HUB</h2>
        <a class="tip-link" href="https://www.youtube.com/@SancoOutdoors" target="_blank">ðŸŽ¬ SUB TO SANCO OUTDOORS</a>
        <br>
        <a class="tip-link" style="background:#00ffff; color:#000;" href="https://www.sanangelogives.org/organization/emmanuelschooloffinearts" target="_blank">ðŸŽ» TIP ESOFA</a>
        <div style="margin-top:20px; color:#666; cursor:pointer;" onclick="toggleModal(false)">[ CLOSE ]</div>
    </div>

    <button id="tip-menu-btn" class="btn" onclick="toggleModal(true)">SUPPORT</button>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
    const engine = Engine.create();
    const width = 400, height = 600;

    const render = Render.create({
        element: document.getElementById('game-container'),
        engine: engine,
        options: { width, height, wireframes: false, background: 'transparent' }
    });

    const ORBS = [
        { r: 25, icon: 'ðŸŽµ', pts: 10 },
        { r: 35, icon: 'ðŸªˆ', pts: 20 },
        { r: 45, icon: 'ðŸŽº', pts: 40 },
        { r: 55, icon: 'ðŸŽ·', pts: 80 },
        { r: 70, icon: 'ðŸŽ»', pts: 150 }
    ];

    // Walls
    const ground = Bodies.rectangle(200, 610, 400, 60, { isStatic: true, render: { fillStyle: '#111' } });
    const leftWall = Bodies.rectangle(-10, 300, 20, 600, { isStatic: true });
    const rightWall = Bodies.rectangle(410, 300, 20, 600, { isStatic: true });
    Composite.add(engine.world, [ground, leftWall, rightWall]);

    let score = 0, currentIdx = 0, nextIdx = 1, canDrop = true, mouseX = 200, modalOpen = false;

    function toggleModal(show) { modalOpen = show; document.getElementById('donation-modal').style.display = show ? 'flex' : 'none'; }

    function drop() {
        if(!canDrop || modalOpen) return;
        canDrop = false;
        
        const ball = Bodies.circle(mouseX, 50, ORBS[currentIdx].r, {
            restitution: 0.4,
            friction: 0.1,
            plugin: { icon: ORBS[currentIdx].icon, r: ORBS[currentIdx].r, idx: currentIdx }
        });
        
        Composite.add(engine.world, ball);
        
        currentIdx = nextIdx;
        nextIdx = Math.floor(Math.random() * 3);
        document.getElementById('next-icon').innerText = ORBS[nextIdx].icon;
        
        setTimeout(() => { canDrop = true; }, 500);
    }

    render.canvas.addEventListener('mousemove', (e) => {
        const rect = render.canvas.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
    });

    render.canvas.addEventListener('mousedown', drop);
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') drop(); });

    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach(pair => {
            const a = pair.bodyA;
            const b = pair.bodyB;
            if(a.plugin.idx !== undefined && a.plugin.idx === b.plugin.idx) {
                const idx = a.plugin.idx;
                if(idx < ORBS.length - 1) {
                    const newX = (a.position.x + b.position.x) / 2;
                    const newY = (a.position.y + b.position.y) / 2;
                    Composite.remove(engine.world, [a, b]);
                    const upgraded = Bodies.circle(newX, newY, ORBS[idx+1].r, {
                        plugin: { icon: ORBS[idx+1].icon, r: ORBS[idx+1].r, idx: idx+1 }
                    });
                    Composite.add(engine.world, upgraded);
                    score += ORBS[idx+1].pts;
                    document.getElementById('score').innerText = score;
                }
            }
        });
    });

    Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        // Ghost
        if(canDrop && !modalOpen) {
            ctx.globalAlpha = 0.5;
            ctx.font = "40px serif";
            ctx.textAlign = "center";
            ctx.fillText(ORBS[currentIdx].icon, mouseX, 50);
            ctx.globalAlpha = 1;
        }
        // Bodies
        engine.world.bodies.forEach(body => {
            if(body.plugin.icon) {
                ctx.save();
                ctx.translate(body.position.x, body.position.y);
                ctx.rotate(body.angle);
                ctx.font = `${body.plugin.r * 1.5}px serif`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(body.plugin.icon, 0, 0);
                ctx.restore();
            }
        });
    });

    Render.run(render);
    Runner.run(Runner.create(), engine);
</script>
</body>
</html>
