<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESOFA Harmony Drop: V1.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #050508; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffff; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .panel { position: absolute; background: rgba(0, 255, 255, 0.05); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; pointer-events: none; z-index: 10; }
        #stats { top: 20px; left: 20px; width: 140px; text-align: center; }
        #score { font-size: 42px; font-weight: bold; color: #fff; }
        #next-preview { bottom: 20px; left: 20px; width: 100px; text-align: center; border-color: #ff00ff; }
        
        /* Modal Style */
        #donation-modal {
            position: absolute; display: none; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.95); padding: 30px; border: 3px solid #ff00ff; border-radius: 15px;
            z-index: 1000; width: 320px;
        }
        .tip-link {
            width: 100%; padding: 12px; margin: 5px 0; background: transparent; 
            border: 1px solid #00ffff; color: #00ffff; text-decoration: none; 
            text-align: center; font-weight: bold; border-radius: 5px; font-size: 13px;
        }
        .yt-link { border-color: #ff0000; color: #ff0000; background: rgba(255,0,0,0.1); }
        
        .btn { position: absolute; cursor: pointer; background: #fff; color: #000; padding: 12px 20px; border: none; font-weight: bold; border-radius: 5px; z-index: 100; }
        #tip-menu-btn { bottom: 20px; right: 20px; background: #ff00ff; color: #fff; }
        canvas { border: 3px solid #00ffff; border-radius: 10px; background: #050508; cursor: crosshair; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="stats" class="panel">
        <div>HYPE SCORE</div>
        <div id="score">0</div>
    </div>

    <div id="next-preview" class="panel">
        <div style="font-size: 10px;">UPCOMING</div>
        <div id="next-icon" style="font-size:40px;">ü™à</div>
    </div>

    <div id="donation-modal">
        <h2 style="color:#ff00ff; margin:0 0 10px 0;">COMMUNITY HUB</h2>
        <a class="tip-link yt-link" href="https://www.youtube.com/@treavorbutts" target="_blank">‚ñ∂ SUBSCRIBE TO TREAVOR BUTTS</a>
        <p style="font-size: 10px; color: #888; margin-bottom: 15px;">Support the local creator!</p>
        
        <a class="tip-link" href="https://www.sanangelogives.org/organization/emmanuelschooloffinearts" target="_blank">üéª Tip Main ESOFA Fund</a>
        <a class="tip-link" href="#" target="_blank">üéπ Tip Piano Program</a>
        <div style="margin-top:15px; color:#666; cursor:pointer;" onclick="toggleModal(false)">[ BACK TO PERFORMANCE ]</div>
    </div>

    <button id="tip-menu-btn" class="btn" onclick="toggleModal(true)">üíù SUPPORT HUB</button>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
    const engine = Engine.create();
    const width = 400, height = 650;

    const render = Render.create({
        element: document.getElementById('game-container'),
        engine: engine,
        options: { width, height, wireframes: false, background: 'transparent' }
    });

    const ORBS = [
        { r: 22, icon: 'üéµ', pts: 10, color: '#00ffff' },
        { r: 32, icon: 'ü™à', pts: 20, color: '#ff00ff' },
        { r: 42, icon: 'üé∫', pts: 40, color: '#ffff00' },
        { r: 52, icon: 'üé∑', pts: 80, color: '#00ff00' },
        { r: 65, icon: 'üéª', pts: 150, color: '#ff4500' },
        { r: 80, icon: 'üé∏', pts: 300, color: '#1e90ff' },
        { r: 95, icon: 'ü•Å', pts: 600, color: '#9400d3' }
    ];

    const ground = Bodies.rectangle(width/2, height+25, width, 60, { isStatic: true, render: { fillStyle: '#333' } });
    const wallL = Bodies.rectangle(-25, height/2, 50, height, { isStatic: true });
    const wallR = Bodies.rectangle(width+25, height/2, 50, height, { isStatic: true });
    Composite.add(engine.world, [ground, wallL, wallR]);

    let score = 0, currentIdx = 0, nextIdx = 1, canDrop = true, mouseX = width/2, modalOpen = false;

    function toggleModal(show) {
        modalOpen = show;
        document.getElementById('donation-modal').style.display = show ? 'flex' : 'none';
    }

    function dropOrb() {
        if(!canDrop || modalOpen) return;
        canDrop = false;
        const orb = Bodies.circle(mouseX, 50, ORBS[currentIdx].r, {
            label: 'orb_' + currentIdx,
            render: { fillStyle: 'transparent' }
        });
        Composite.add(engine.world, orb);
        currentIdx = nextIdx;
        nextIdx = Math.floor(Math.random() * 3);
        document.getElementById('next-icon').innerText = ORBS[nextIdx].icon;
        setTimeout(() => canDrop = true, 600);
    }

    window.addEventListener('keydown', (e) => { if (e.code === 'Space') dropOrb(); });
    render.canvas.addEventListener('mousemove', (e) => {
        const rect = render.canvas.getBoundingClientRect();
        mouseX = Math.max(ORBS[currentIdx].r, Math.min(width - ORBS[currentIdx].r, e.clientX - rect.left));
    });
    render.canvas.addEventListener('mousedown', dropOrb);

    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach(pair => {
            if(pair.bodyA.label === pair.bodyB.label && pair.bodyA.label.includes('orb_')) {
                const idx = parseInt(pair.bodyA.label.split('_')[1]);
                if(idx < ORBS.length - 1) {
                    const midX = (pair.bodyA.position.x + pair.bodyB.position.x) / 2;
                    const midY = (pair.bodyA.position.y + pair.bodyB.position.y) / 2;
                    Composite.remove(engine.world, [pair.bodyA, pair.bodyB]);
                    const newOrb = Bodies.circle(midX, midY, ORBS[idx+1].r, {
                        label: 'orb_' + (idx+1), render: { fillStyle: 'transparent' }
                    });
                    Composite.add(engine.world, newOrb);
                    score += ORBS[idx+1].pts;
                    document.getElementById('score').innerText = score;
                }
            }
        });
    });

    Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        // GHOST PREVIEW FIX
        if(canDrop && !modalOpen) {
            ctx.save();
            ctx.globalAlpha = 0.5; // Made it brighter
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.font = `${ORBS[currentIdx].r * 1.5}px serif`;
            ctx.fillText(ORBS[currentIdx].icon, mouseX, 50);
            ctx.strokeStyle = ORBS[currentIdx].color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(mouseX, 50, ORBS[currentIdx].r, 0, Math.PI*2);
            ctx.stroke();
            ctx.restore();
        }

        engine.world.bodies.forEach(body => {
            if(body.label.includes('orb_')) {
                const idx = parseInt(body.label.split('_')[1]);
                const info = ORBS[idx];
                ctx.save();
                ctx.translate(body.position.x, body.position.y);
                ctx.rotate(body.angle);
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.font = `${info.r * 1.5}px serif`;
                ctx.fillText(info.icon, 0, 0);
                ctx.restore();
            }
        });
    });

    Render.run(render);
    Runner.run(Runner.create(), engine);
</script>
</body>
</html>
