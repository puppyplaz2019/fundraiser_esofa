<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESOFA Harmony Drop: Symphony Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #050508; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffff; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        .panel { position: absolute; background: rgba(0, 255, 255, 0.05); border: 1px solid #00ffff; border-radius: 10px; padding: 15px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.2); }
        
        #stats { top: 20px; left: 20px; width: 140px; text-align: center; }
        #score { font-size: 36px; font-weight: bold; color: #fff; text-shadow: 0 0 10px #00ffff; }
        
        #leaderboard { top: 20px; right: 20px; width: 200px; }
        .entry { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: #fff; }

        #next-preview { bottom: 20px; left: 20px; width: 100px; text-align: center; }
        #next-icon { font-size: 40px; margin-top: 5px; }
        
        #donate-btn {
            position: absolute; bottom: 20px; right: 20px;
            background: #fff; color: #000; padding: 15px 25px; border-radius: 5px;
            text-decoration: none; font-weight: bold; font-size: 18px;
            box-shadow: 0 0 15px #fff; transition: 0.3s; z-index: 100;
        }
        #donate-btn:hover { background: #00ffff; box-shadow: 0 0 20px #00ffff; }

        canvas { border: 2px solid #00ffff; border-radius: 5px; background: #0a0a15; }
        
        #game-over-screen {
            position: absolute; display: none; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.95); padding: 40px; border: 2px solid #fff; border-radius: 10px; z-index: 200;
        }
        input { background: #000; border: 1px solid #00ffff; color: #fff; padding: 10px; text-align: center; outline: none; }
        button { background: #fff; border: none; padding: 10px 20px; margin-top: 15px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="stats" class="panel">
        <div>REVENUE SCORE</div>
        <div id="score">0</div>
        <div style="font-size: 11px; margin-top: 5px; color: #888;">TOP: <span id="best">0</span></div>
    </div>

    <div id="leaderboard" class="panel">
        <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #00ffff;">TOP COMPOSERS</div>
        <div id="leader-list"></div>
    </div>

    <div id="next-preview" class="panel">
        <div style="font-size: 11px;">UPCOMING</div>
        <div id="next-icon">üéµ</div>
    </div>

    <a id="donate-btn" href="https://www.sanangelogives.org/organization/emmanuelschooloffinearts" target="_blank">ü•Å TIP ESOFA</a>

    <div id="game-over-screen">
        <h1 style="color:#fff">CONCERT ENDED</h1>
        <p>Enter your stage name:</p>
        <input type="text" id="player-name" placeholder="MAESTRO" maxlength="10">
        <button onclick="saveScore()">SUBMIT TO BOARD</button>
    </div>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
    const engine = Engine.create();
    const width = 400; const height = 650;

    // Audio Setup
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playNote(freq) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.8);
    }

    const render = Render.create({
        element: document.getElementById('game-container'),
        engine: engine,
        options: { width, height, wireframes: false, background: 'transparent' }
    });

    const ORBS = [
        { r: 20, color: '#333', icon: 'üéµ', name: 'Note', pts: 2, freq: 261.63 }, // C4
        { r: 30, color: '#444', icon: 'ü™à', name: 'Flute', pts: 4, freq: 293.66 }, // D4
        { r: 40, color: '#555', icon: 'üé∫', name: 'Trumpet', pts: 8, freq: 329.63 }, // E4
        { r: 50, color: '#666', icon: 'üé∑', name: 'Sax', pts: 16, freq: 349.23 },   // F4
        { r: 65, color: '#777', icon: 'üéª', name: 'Violin', pts: 32, freq: 392.00 }, // G4
        { r: 80, color: '#888', icon: 'üé∏', name: 'Guitar', pts: 64, freq: 440.00 }, // A4
        { r: 95, color: '#999', icon: 'ü•Å', name: 'Drum', pts: 128, freq: 493.88 },  // B4
        { r: 115, color: '#aaa', icon: 'üéπ', name: 'Piano', pts: 256, freq: 523.25 }, // C5
        { r: 135, color: '#fff', icon: 'üî±', name: 'HARP', pts: 512, freq: 587.33 }  // D5
    ];

    const ground = Bodies.rectangle(width/2, height+25, width, 60, { isStatic: true, render: { fillStyle: '#00ffff' } });
    const wallL = Bodies.rectangle(-25, height/2, 50, height, { isStatic: true });
    const wallR = Bodies.rectangle(width+25, height/2, 50, height, { isStatic: true });
    Composite.add(engine.world, [ground, wallL, wallR]);

    let score = 0;
    let nextIdx = 0;
    let canDrop = true;
    let leaders = JSON.parse(localStorage.getItem('esofa_leaders')) || [];

    function dropOrb(x) {
        if(!canDrop) return;
        canDrop = false;
        const orb = Bodies.circle(x, 50, ORBS[nextIdx].r, {
            restitution: 0.4,
            label: 'orb_' + nextIdx,
            render: { fillStyle: 'transparent' } // We will draw the icons manually
        });
        Composite.add(engine.world, orb);
        playNote(ORBS[nextIdx].freq / 2); // Low drop sound
        
        nextIdx = Math.floor(Math.random() * 3);
        document.getElementById('next-icon').innerText = ORBS[nextIdx].icon;
        setTimeout(() => canDrop = true, 600);
    }

    render.canvas.addEventListener('mousedown', (e) => {
        const rect = render.canvas.getBoundingClientRect();
        dropOrb(e.clientX - rect.left);
    });

    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach(pair => {
            if(pair.bodyA.label === pair.bodyB.label && pair.bodyA.label.includes('orb_')) {
                const idx = parseInt(pair.bodyA.label.split('_')[1]);
                if(idx < ORBS.length - 1) {
                    const midX = (pair.bodyA.position.x + pair.bodyB.position.x) / 2;
                    const midY = (pair.bodyA.position.y + pair.bodyB.position.y) / 2;
                    Composite.remove(engine.world, [pair.bodyA, pair.bodyB]);
                    const newOrb = Bodies.circle(midX, midY, ORBS[idx+1].r, {
                        label: 'orb_' + (idx+1),
                        render: { fillStyle: 'transparent' }
                    });
                    Composite.add(engine.world, newOrb);
                    playNote(ORBS[idx+1].freq);
                    score += ORBS[idx+1].pts;
                    document.getElementById('score').innerText = score;
                }
            }
        });
    });

    // Custom Rendering for Icons
    Events.on(render, 'afterRender', () => {
        const context = render.context;
        engine.world.bodies.forEach(body => {
            if(body.label.includes('orb_')) {
                const idx = parseInt(body.label.split('_')[1]);
                const info = ORBS[idx];
                context.save();
                context.translate(body.position.x, body.position.y);
                context.rotate(body.angle);
                
                // Draw circle backing
                context.beginPath();
                context.arc(0, 0, info.r, 0, Math.PI * 2);
                context.fillStyle = 'rgba(0, 255, 255, 0.1)';
                context.strokeStyle = '#00ffff';
                context.lineWidth = 2;
                context.fill();
                context.stroke();

                // Draw Icon
                context.textAlign = "center";
                context.textBaseline = "middle";
                context.font = `${info.r * 1.2}px serif`;
                context.fillText(info.icon, 0, 0);
                context.restore();
            }
        });
    });

    setInterval(() => {
        engine.world.bodies.forEach(b => {
            if(b.position.y < 100 && !b.isStatic && b.id > 10) {
                document.getElementById('game-over-screen').style.display = 'flex';
            }
        });
    }, 2000);

    function saveScore() {
        const name = document.getElementById('player-name').value || "ANON";
        leaders.push({name, score});
        localStorage.setItem('esofa_leaders', JSON.stringify(leaders.sort((a,b)=>b.score-a.score).slice(0, 10)));
        location.reload();
    }

    function updateLeaderboard() {
        const list = document.getElementById('leader-list');
        list.innerHTML = leaders.map(l => `<div class="entry"><span>${l.name}</span><span>${l.score}</span></div>`).join('');
        document.getElementById('best').innerText = leaders[0]?.score || 0;
    }

    Render.run(render);
    Runner.run(Runner.create(), engine);
    updateLeaderboard();
</script>
</body>
</html>
